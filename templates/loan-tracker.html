<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loan Tracker</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .navbar-brand {
            font-weight: 700;
            color: #3b82f6 !important;
        }

        .nav-link {
            color: #64748b !important;
            font-weight: 500;
        }

        .nav-link.active {
            background: #3b82f6 !important;
            color: white !important;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1.25rem 0.75rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            display: block;
            line-height: 1.2;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .file-card {
            transition: transform 0.2s ease;
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }

        .file-number {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-received {
            color: #059669;
            font-weight: 500;
        }

        .status-bounce {
            color: #dc3545;
            font-weight: 500;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .toast {
            border-radius: 8px;
        }

        .scroll-hint {
            background: #f8fafc;
            color: #64748b;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .stat-value {
                font-size: 1rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
        }

        /* View management */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Mobile-friendly navbar */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.5rem 1rem;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .navbar-nav {
                flex-direction: row;
                gap: 0.5rem;
                align-items: center;
            }
            
            .nav-link {
                padding: 0.25rem 0.5rem;
                font-size: 0.9rem;
            }
            
            .nav-link i {
                margin-right: 0.25rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">üìä Jagdamb Finance</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="#" onclick="showView('active', event)">
                    <i class="fas fa-list"></i> Active Files
                </a>
                <a class="nav-link" href="#" onclick="showView('history', event)">
                    <i class="fas fa-history"></i> History
                </a>
                <a class="nav-link" href="#" onclick="showView('create', event)">
                    <i class="fas fa-plus"></i> Create File
                </a>
                <div class="navbar-nav ms-3">
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container py-4">
        <!-- Active Files View -->
        <div id="active-files-view" class="view active">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="active-count">0</div>
                            <div class="stat-label">Active Files</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="total-pending">‚Çπ0</div>
                            <div class="stat-label">Total Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" id="active-files-grid">
                <!-- Files will be populated here -->
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Closed Files</h2>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-value" id="closed-count">0</div>
                        <div class="stat-label">Closed Files</div>
                    </div>
                </div>
            </div>

            <div class="row" id="history-files-grid">
                <!-- Closed files will be populated here -->
            </div>
        </div>

        <!-- Create File View -->
        <div id="create-file-view" class="view">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">Create New File</h3>
                        </div>
                        <div class="card-body">
                            <form id="create-file-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="personFullName" class="form-label">Person Full Name *</label>
                                        <input type="text" class="form-control" id="personFullName" name="personFullName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="personMobile" class="form-label">Person Mobile *</label>
                                        <input type="tel" class="form-control" id="personMobile" name="personMobile" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="referenceMobile" class="form-label">Reference Mobile *</label>
                                        <input type="tel" class="form-control" id="referenceMobile" name="referenceMobile" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="businessName" class="form-label">Business Name *</label>
                                        <input type="text" class="form-control" id="businessName" name="businessName" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="address" class="form-label">Address *</label>
                                    <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="businessAddress" class="form-label">Business Address *</label>
                                    <textarea class="form-control" id="businessAddress" name="businessAddress" rows="2" required></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="principalAmount" class="form-label">Principal Amount (‚Çπ) *</label>
                                        <input type="number" class="form-control" id="principalAmount" name="principalAmount" min="1" max="500000" required>
                                        <div class="form-text">Maximum ‚Çπ500,000</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="installment" class="form-label">Daily Installment (‚Çπ) *</label>
                                        <input type="number" class="form-control" id="installment" name="installment" min="1" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fileStartDate" class="form-label">File Start Date *</label>
                                        <input type="date" class="form-control" id="fileStartDate" name="fileStartDate" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="fileEndDate" class="form-label">File End Date *</label>
                                        <input type="date" class="form-control" id="fileEndDate" name="fileEndDate" required>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-secondary" onclick="showView('active', null)">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Create File
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Details View -->
        <div id="file-details-view" class="view">
            <div class="d-flex align-items-center mb-4">
                <button class="btn btn-secondary me-3" onclick="showView('active', null)">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 id="file-details-title" class="mb-0">File Details</h2>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 id="file-person-name" class="mb-0">Person Name</h3>
                                <span class="file-number" id="file-number">#1</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-4">
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-principal">‚Çπ0</div>
                                        <div class="stat-label">Principal Amount</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-installment">‚Çπ0</div>
                                        <div class="stat-label">Daily Installment</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-received">‚Çπ0</div>
                                        <div class="stat-label">Total Received</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-pending">‚Çπ0</div>
                                        <div class="stat-label">Pending Amount</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-bounces">0</div>
                                        <div class="stat-label">Bounces</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-transactions">0</div>
                                        <div class="stat-label">Transactions</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-start-date">-</div>
                                        <div class="stat-label">Start Date</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card">
                                        <div class="stat-value" id="file-details-end-date">-</div>
                                        <div class="stat-label">End Date</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" id="mark-payment-btn">
                                    <i class="fas fa-plus"></i> Mark Payment Received
                                </button>
                                <button class="btn btn-success" id="close-file-btn">
                                    <i class="fas fa-check"></i> Close File
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">Transaction History</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="scroll-hint d-none d-md-block">‚Üê Scroll horizontally to see all columns ‚Üí</div>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="transactions-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Mode</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-tbody">
                                        <!-- Transactions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Payment Modal -->
    <div class="modal fade" id="payment-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Payment Received</h5>
                    <button type="button" class="btn-close" onclick="closePaymentModal()"></button>
                </div>
                <form id="payment-form">
                    <div class="modal-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <button type="button" class="btn btn-outline-secondary" onclick="changePaymentDate('prev')">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </div>
                            <div class="col">
                                <input type="date" class="form-control" id="payment-date" name="paymentDate" required>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-outline-secondary" onclick="changePaymentDate('next')">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="payment-amount" class="form-label">Amount (‚Çπ) *</label>
                            <input type="number" class="form-control" id="payment-amount" name="paymentAmount" min="1" required>
                        </div>

                        <div class="mb-3">
                            <label for="payment-mode" class="form-label">Payment Mode</label>
                            <select class="form-select" id="payment-mode" name="paymentMode">
                                <option value="CASH">Cash</option>
                                <option value="UPI" selected>UPI</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="CHEQUE">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Mark Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toasts will be added here dynamically -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin;

        // Global variables
        let files = [];
        let currentFile = null;
        let currentView = 'active';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkAuth();
            // Ensure only the active view is shown initially
            showView('active', null);
            loadFiles();
            setupEventListeners();
        }

        // Authentication helpers
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        function handleAuthError() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login';
        }

        function handleApiResponse(response, errorMessage) {
            if (response.status === 401) {
                handleAuthError();
                return null;
            }
            if (!response.ok) {
                throw new Error(errorMessage);
            }
            return response.json();
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = '/';
            }
        }

        // View management
        function showView(viewName, event = null) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
            });

            // Map view names to actual element IDs
            const viewIdMap = {
                'active': 'active-files-view',
                'history': 'history-view',
                'create': 'create-file-view',
                'file-details': 'file-details-view'
            };

            // Show selected view
            const targetViewId = viewIdMap[viewName] || `${viewName}-view`;
            const targetView = document.getElementById(targetViewId);
            if (targetView) {
                targetView.classList.add('active');
                targetView.style.display = 'block';
            } else {
                console.error(`View not found: ${targetViewId}`);
            }

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Update the clicked nav link if event is provided
            if (event && event.target) {
                event.target.classList.add('active');
            }

            currentView = viewName;

            // Load data for the view
            if (viewName === 'active' || viewName === 'history') {
                loadFiles();
            }
        }

        // Load files from backend
        async function loadFiles() {
            try {
                console.log('Loading files from Python backend...');
                const response = await fetch(`${API_BASE_URL}/api/files?status=${currentView === 'history' ? 'CLOSED' : 'ACTIVE'}`, {
                    headers: getAuthHeaders()
                });
                
                const data = await handleApiResponse(response, 'Error loading files');
                if (!data) return; // Auth error handled

                files = data;

                // Update stats based on current view
                if (currentView === 'active') {
                    const activeCountEl = document.getElementById('active-count');
                    const totalPendingEl = document.getElementById('total-pending');

                    if (activeCountEl) {
                        activeCountEl.textContent = files.length;
                    }

                    const totalPending = files.reduce((sum, file) => {
                        return sum + file.pendingAmount;
                    }, 0);

                    if (totalPendingEl) {
                        totalPendingEl.textContent = `‚Çπ${totalPending.toLocaleString()}`;
                    }
                } else if (currentView === 'history') {
                    const closedCountEl = document.getElementById('closed-count');
                    if (closedCountEl) {
                        closedCountEl.textContent = files.length;
                    }
                }

                // Render files
                const filesGrid = currentView === 'history' ?
                    document.getElementById('history-files-grid') :
                    document.getElementById('active-files-grid');

                if (filesGrid) {
                    filesGrid.innerHTML = '';

                    files.forEach(file => {
                        const fileCard = createFileCard(file);
                        filesGrid.appendChild(fileCard);
                    });
                }

            } catch (error) {
                console.error('Error loading files:', error);
                showToast('Error loading files: ' + error.message, 'error');
            }
        }

        // Create file card element
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-3';

            const pendingAmount = file.pendingAmount;

            card.innerHTML = `
                <div class="card file-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1">${file.personName}</h5>
                                <p class="card-text text-muted small mb-0">${file.personMobile}</p>
                            </div>
                            <span class="file-number">#${file.id}</span>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">‚Çπ${file.principalAmount.toLocaleString()}</div>
                                    <div class="stat-label">Principal</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">‚Çπ${file.installment.toLocaleString()}</div>
                                    <div class="stat-label">Daily</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">‚Çπ${file.totalReceived.toLocaleString()}</div>
                                    <div class="stat-label">Received</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-value">‚Çπ${pendingAmount.toLocaleString()}</div>
                                    <div class="stat-label">Pending</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm view-details-btn" data-file-id="${file.id}">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${file.status === 'ACTIVE' ? `
                                <button class="btn btn-success btn-sm mark-payment-btn" data-file-id="${file.id}">
                                    <i class="fas fa-plus"></i> Mark Payment
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            const viewDetailsBtn = card.querySelector('.view-details-btn');
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener('click', function () {
                    const fileId = parseInt(this.getAttribute('data-file-id'));
                    viewFile(fileId);
                });
            }

            const markPaymentBtn = card.querySelector('.mark-payment-btn');
            if (markPaymentBtn) {
                markPaymentBtn.addEventListener('click', function () {
                    const fileId = parseInt(this.getAttribute('data-file-id'));
                    console.log('Mark payment clicked for file:', fileId);
                    openPaymentModal(fileId);
                });
            }

            return card;
        }

        // View file details
        function viewFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) return;

            currentFile = file;

            // Populate file details
            const elements = {
                'file-details-title': file.personName,
                'file-person-name': file.personName,
                'file-number': `#${file.id}`,
                'file-principal': `‚Çπ${file.principalAmount.toLocaleString()}`,
                'file-installment': `‚Çπ${file.installment.toLocaleString()}`,
                'file-received': `‚Çπ${file.totalReceived.toLocaleString()}`,
                'file-pending': `‚Çπ${file.pendingAmount.toLocaleString()}`,
                'file-bounces': file.bounces,
                'file-transactions': file.transactions,
                'file-start-date': formatDate(file.fileStartDate),
                'file-details-end-date': formatDate(file.fileEndDate)
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                }
            });

            // Show/hide close file button
            const closeBtn = document.getElementById('close-file-btn');
            if (closeBtn) {
                if (file.status === 'ACTIVE') {
                    closeBtn.style.display = 'inline-flex';
                } else {
                    closeBtn.style.display = 'none';
                }
            }

            // Load transactions
            loadTransactions(fileId);

            // Show file details view
            showView('file-details', null);

            // Re-setup payment modal button for the new view
            setTimeout(() => {
                setupPaymentModalButton();
            }, 100);
        }

        // Load transactions for a file from Python backend
        async function loadTransactions(fileId) {
            const tbody = document.getElementById('transactions-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            try {
                console.log('Loading transactions from Python backend for file', fileId);
                const response = await fetch(`${API_BASE_URL}/api/files/${fileId}/transactions`, {
                    headers: getAuthHeaders()
                });
                
                const data = await handleApiResponse(response, 'Error loading transactions');
                if (!data) return; // Auth error handled

                const transactions = data || [];
                const file = files.find(f => f.id === fileId);

                if (!file) return;

                // Get date range - limit to today for active files
                const startDate = new Date(file.fileStartDate);
                const today = new Date();
                const endDate = file.status === 'CLOSED' ? 
                    new Date(file.fileEndDate) : 
                    new Date(Math.min(today.getTime(), new Date(file.fileEndDate).getTime()));

                // Create date range for transactions
                const dateRange = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d));
                }

                // Sort transactions by date (newest first)
                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                // Display transactions in reverse chronological order
                sortedTransactions.forEach(transaction => {
                    const row = createTransactionRow(transaction, file);
                    tbody.appendChild(row);
                });

                // Add bounce entries for missing dates
                dateRange.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const hasTransaction = transactions.some(t => t.date === dateStr);
                    
                    if (!hasTransaction) {
                        const bounceRow = createBounceRow(dateStr, file);
                        tbody.appendChild(bounceRow);
                    }
                });

            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Error loading transactions: ' + error.message, 'error');
            }
        }

        // Create transaction row
        function createTransactionRow(transaction, file) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(transaction.date)}</td>
                <td>‚Çπ${transaction.amount.toLocaleString()}</td>
                <td>${transaction.mode}</td>
                <td><span class="status-received">Received</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTransaction(${transaction.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            return row;
        }

        // Create bounce row
        function createBounceRow(dateStr, file) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(dateStr)}</td>
                <td>-</td>
                <td>-</td>
                <td><span class="status-bounce">BOUNCE</span></td>
                <td>-</td>
            `;
            return row;
        }

        // Payment modal functions
        function openPaymentModal(fileId = null) {
            console.log('openPaymentModal called with fileId:', fileId);
            
            if (fileId) {
                currentFile = files.find(f => f.id === fileId);
                console.log('Found currentFile:', currentFile);
            }

            if (!currentFile) {
                console.error('No current file selected');
                return;
            }

            if (currentFile.status !== 'ACTIVE') {
                showToast('Cannot add payment to closed file', 'error');
                return;
            }

            const paymentDateEl = document.getElementById('payment-date');
            const paymentAmountEl = document.getElementById('payment-amount');
            const paymentModalEl = document.getElementById('payment-modal');

            console.log('Modal elements found:', {
                paymentDateEl: !!paymentDateEl,
                paymentAmountEl: !!paymentAmountEl,
                paymentModalEl: !!paymentModalEl
            });

            if (!paymentDateEl || !paymentAmountEl || !paymentModalEl) {
                console.error('Required modal elements not found');
                return;
            }

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            paymentDateEl.value = today;

            // Set min date to file start date, max date to today (no future dates)
            paymentDateEl.min = currentFile.fileStartDate;
            paymentDateEl.max = today;

            // Set default amount to daily installment
            paymentAmountEl.value = currentFile.installment;

            // Show modal using Bootstrap
            const modal = new bootstrap.Modal(paymentModalEl);
            modal.show();
        }

        function closePaymentModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('payment-modal'));
            if (modal) {
                modal.hide();
            }
        }

        function changePaymentDate(direction) {
            const dateInput = document.getElementById('payment-date');
            const currentDate = new Date(dateInput.value);
            const today = new Date();
            const fileStartDate = new Date(currentFile.fileStartDate);

            let newDate;
            if (direction === 'prev') {
                newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() - 1);
            } else {
                newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + 1);
            }

            // Validate date range
            if (newDate <= today && newDate >= fileStartDate) {
                dateInput.value = newDate.toISOString().split('T')[0];
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Create file form
            const createFileForm = document.getElementById('create-file-form');
            if (createFileForm) {
                createFileForm.addEventListener('submit', handleCreateFile);
            }

            // Payment form
            const paymentForm = document.getElementById('payment-form');
            if (paymentForm) {
                paymentForm.addEventListener('submit', handlePayment);
            }

            // Close file button
            const closeFileBtn = document.getElementById('close-file-btn');
            if (closeFileBtn) {
                closeFileBtn.addEventListener('click', handleCloseFile);
            }

            // Setup payment modal button
            setupPaymentModalButton();
        }

        function setupPaymentModalButton() {
            const markPaymentBtn = document.getElementById('mark-payment-btn');
            if (markPaymentBtn) {
                markPaymentBtn.addEventListener('click', function() {
                    if (currentFile) {
                        openPaymentModal();
                    }
                });
            }
        }

        // Form handlers
        async function handleCreateFile(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const fileData = {
                personFullName: formData.get('personFullName'),
                personMobile: formData.get('personMobile'),
                referenceMobile: formData.get('referenceMobile'),
                address: formData.get('address'),
                businessName: formData.get('businessName'),
                businessAddress: formData.get('businessAddress'),
                principalAmount: parseFloat(formData.get('principalAmount')),
                installment: parseFloat(formData.get('installment')),
                fileStartDate: formData.get('fileStartDate'),
                fileEndDate: formData.get('fileEndDate')
            };

            // Validate required fields
            const requiredFields = ['personFullName', 'personMobile', 'referenceMobile', 'address', 'businessName', 'businessAddress', 'principalAmount', 'installment', 'fileStartDate', 'fileEndDate'];
            for (const field of requiredFields) {
                if (!fileData[field] || (typeof fileData[field] === 'string' && fileData[field].trim() === '')) {
                    showToast(`${field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())} is required`, 'error');
                    return;
                }
            }

            // Validate amount
            if (fileData.principalAmount <= 0 || fileData.principalAmount > 500000) {
                showToast('Principal amount must be between ‚Çπ1 and ‚Çπ500,000', 'error');
                return;
            }

            // Validate installment
            if (fileData.installment <= 0) {
                showToast('Daily installment must be positive', 'error');
                return;
            }

            // Validate start date - can be past date (historic)
            const startDate = new Date(fileData.fileStartDate);
            // No validation needed for start date being in the past - it's allowed

            // Validate end date
            const endDate = new Date(fileData.fileEndDate);
            if (endDate <= startDate) {
                showToast('File end date must be after start date', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/files`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(fileData)
                });

                const data = await handleApiResponse(response, 'Error creating file');
                if (!data) return; // Auth error handled

                showToast('File created successfully!', 'success');
                e.target.reset();
                showView('active', null);
            } catch (error) {
                console.error('Error creating file:', error);
                showToast('Error creating file: ' + error.message, 'error');
            }
        }

        async function handlePayment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const paymentData = {
                fileNumber: currentFile.id,
                date: formData.get('paymentDate'),
                amount: parseFloat(formData.get('paymentAmount')),
                mode: formData.get('paymentMode')
            };

            // Validate date - no future dates
            const paymentDate = new Date(paymentData.date);
            const today = new Date();
            if (paymentDate > today) {
                showToast('Payment date cannot be in the future', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/transactions`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(paymentData)
                });

                const data = await handleApiResponse(response, 'Error adding payment');
                if (!data) return; // Auth error handled

                showToast('Payment marked successfully!', 'success');
                closePaymentModal();
                
                // Reload current view
                if (currentView === 'file-details') {
                    viewFile(currentFile.id);
                } else {
                    loadFiles();
                }
            } catch (error) {
                console.error('Error adding payment:', error);
                showToast('Error adding payment: ' + error.message, 'error');
            }
        }

        async function handleCloseFile() {
            if (!currentFile) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/files/${currentFile.id}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'CLOSED' })
                });

                const data = await handleApiResponse(response, 'Error closing file');
                if (!data) return; // Auth error handled

                showToast('File closed successfully!', 'success');
                showView('active', null);
            } catch (error) {
                console.error('Error closing file:', error);
                showToast('Error closing file: ' + error.message, 'error');
            }
        }

        // Transaction management
        async function editTransaction(transactionId) {
            // TODO: Implement edit transaction functionality
            showToast('Edit transaction functionality coming soon!', 'info');
        }

        async function deleteTransaction(transactionId) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await handleApiResponse(response, 'Error deleting transaction');
                if (!data) return; // Auth error handled

                showToast('Transaction deleted successfully!', 'success');
                
                // Reload current view
                if (currentView === 'file-details') {
                    viewFile(currentFile.id);
                } else {
                    loadFiles();
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showToast('Error deleting transaction: ' + error.message, 'error');
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast" id="${toastId}" role="alert">
                    <div class="toast-header">
                        <strong class="me-auto">Loan Tracker</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>

</html>